services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: ids
    ports: ["5432:5432"]
    volumes:
      - postgres_data:/var/lib/postgresql/data

  nats:
    image: nats:2
    ports: ["4222:4222","8222:8222"]

  app:
    build:
      context: ..
      dockerfile: ProyectoFinal_Backend/Dockerfile
    command: sh -c "npx prisma migrate deploy || true; npm run prisma:seed || true; node dist/server.js"
    env_file: [.env]
    environment:
      - EVE_JSON_PATH=${EVE_JSON_PATH:-/var/log/suricata/eve.json}
    depends_on: [db, nats]
    ports: ["8080:8080"]
    volumes:
      # Volumen compartido para eve.json (mismo que ml-pipeline)
      - suricata_logs:/var/log/suricata
    restart: unless-stopped

  detector:
    build:
      context: ..
      dockerfile: ProyectoFinal_Backend/Dockerfile
    command: node dist/main.worker.js
    env_file: [.env]
    depends_on: [nats, db]
    restart: unless-stopped

  ml-pipeline:
    build:
      context: ../../modelo_ML
      dockerfile: Dockerfile
    environment:
      - BACKEND_URL=http://app:8080
      - EVE_JSON_PATH=${EVE_JSON_PATH:-/var/log/suricata/eve.json}
      - SURICATA_RULES_FILE=${SURICATA_RULES_FILE:-/var/log/suricata/rules/generated.rules}
      - INTERVAL_SECONDS=${ML_INTERVAL_SECONDS:-10}
    volumes:
      # Volumen para compartir eve.json con Suricata y el backend
      - suricata_logs:/var/log/suricata
      # Volumen para compartir reglas con Suricata (si Suricata está en otro contenedor)
      - suricata_rules:/var/log/suricata/rules
      # Montar modelos desde el host (los modelos entrenados deben estar aquí)
      - ../../modelo_ML/models:/app/models:ro
      # Montar dataset desde el host (opcional, para referencia)
      - ../../modelo_ML/data:/app/data:ro
      # Directorio para reglas generadas (se guardan en el contenedor)
      # Las reglas se envían al backend, este directorio es solo backup
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - default

volumes:
  postgres_data:
  suricata_logs:
  suricata_rules:
  ml_models:
  ml_data:
  ml_rules:
